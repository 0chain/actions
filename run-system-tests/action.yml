name: "0Chain System Tests"
description: "Run 0Chain System Tests"
inputs:
  system_tests_branch:
    required: false
    description: 'System tests branch to run'
  network:
    required: true
    description: 'Network to run system tests against INSTEAD OF DEPLOYING A NEW NETWORK. [example: dev.0chain.net]'
  zbox_cli_branch:
    required: true
    description: '0Box CLI (branch or commit SHA) which the tests will use'
    default: 'staging'
  zwallet_cli_branch:
    required: true
    description: '0Wallet CLI (branch or commit SHA) which the tests will use'
    default: 'staging'
  smart_contract_owner_wallet_json:
    required: true
    description: 'smart contract owner wallet, used in smart contract config tests'
  deploy_report_page:
    required: true
    default: "true"
    description: ''
  archive_results:
    required: true
    default: "true"
    description: ''
  run_flaky_tests:
    required: true
    default: "true"
    description: ''
  retry_failures:
    required: true
    default: "true"
    description: 'retry failing tests up to 3 times. will not retry when >10 tests have failed as this suggests a wider issue'
  svc_account_secret:
    required: false
    description: 'secret used to publish test results - will use your own credentials if not supplied'
  custom_go_sdk_version:
    required: false
    description: 'custom gosdk version. Will upgrade CLI branches with this before running tests'

runs:
  using: "composite"
  steps:
    - name: "Config: Run tests against 0Chain network"
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo "SYSTEM_TESTS_BRANCH=$(echo $(([ -z '${{inputs.system_tests_branch}}' ] && echo  ${GITHUB_REF#refs/*/}) || echo '${{inputs.system_tests_branch}}'))" >> $GITHUB_ENV
        echo "NETWORK_URL=$(echo ${{ inputs.network }})" >> $GITHUB_ENV
        echo "ZBOX_BRANCH=$(echo ${{inputs.zbox_cli_branch}})" >> $GITHUB_ENV
        echo "ZWALLET_BRANCH=$(echo ${{inputs.zwallet_cli_branch}})" >> $GITHUB_ENV

    - name: "VIEW TEST CONFIGURATION"
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo
        echo "======================================================"
        echo "RUNNING SYSTEM TESTS WITH THE FOLLOWING CONFIGURATION:"
        echo "======================================================"
        echo
        echo "System tests branch:    [${{ env.SYSTEM_TESTS_BRANCH }}]"
        echo "0Chain network URL:     [${{ env.NETWORK_URL }}]"
        echo "0box CLI branch:        [${{ env.ZBOX_BRANCH }}]"
        echo "0wallet CLI branch:     [${{ env.ZWALLET_BRANCH }}]"
        echo "Custom gosdk version:   [${{ inputs.custom_go_sdk_version }}]"

    - name: "Checkout System Tests"
      uses: actions/checkout@v2
      with:
        repository: "0chain/system_test"
        ref: ${{ env.SYSTEM_TESTS_BRANCH }}


#    - name: "Get CLI Cache Key"
#      shell: 'script --return --quiet --command "bash {0}"'
#      run: |
#        if [[ '${{ env.ZWALLET_BRANCH }}' =~ ^[a-f0-9]{40}$ ]];
#          then
#            echo ZWALLET_SHA=${{ env.ZWALLET_BRANCH }} >> $GITHUB_ENV
#          else
#           echo ZWALLET_SHA=$(curl --silent --fail https://api.github.com/repos/0chain/zwalletcli/git/refs/heads/${{ env.ZWALLET_BRANCH }} | jq --raw-output .object.sha) >> $GITHUB_ENV
#        fi
#
#        if [[ '${{ env.ZBOX_BRANCH }}' =~ ^[a-f0-9]{40}$ ]];
#          then
#            echo ZBOX_SHA=${{ env.ZBOX_BRANCH }} >> $GITHUB_ENV
#          else
#           echo ZBOX_SHA=$(curl --silent --fail https://api.github.com/repos/0chain/zboxcli/git/refs/heads/${{ env.ZBOX_BRANCH }} | jq --raw-output .object.sha) >> $GITHUB_ENV
#        fi
#
#    - name: "Cache CLI Binaries"
#      id: cli-cache
#      uses: actions/cache@v2
#      with:
#        path: |
#          tests/cli_tests/zbox
#          tests/cli_tests/zwallet
#        key: cli-cache-${{ runner.os }}-${{ env.ZWALLET_SHA }}-${{ env.ZBOX_SHA }}-v3

    - name: "Checkout 0wallet CLI"
#      if: steps.cli-cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v2
      with:
        ref: ${{ env.ZWALLET_BRANCH }}
        repository: 0chain/zwalletcli
        fetch-depth: 1
        path: ./zwalletcli

    - name: "Checkout 0box CLI"
#      if: steps.cli-cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v2
      with:
        ref: ${{ env.ZBOX_BRANCH }}
        repository: 0chain/zboxcli
        fetch-depth: 1
        path: ./zboxcli

    - name: "Setup Go"
      uses: actions/setup-go@v2
      with:
        go-version: 1.17.2

    - name: "Install dependencies"
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo
        echo "======================================================"
        echo "INSTALL REQUIRED DEPENDENCIES"
        echo "======================================================"
        echo
        echo "installing youtube-dl..."
        sudo curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl > build.log 2>&1 || { cat build.log && echo "::error title=Failed to install test dependency::failed to install youtube-dl" && exit 1; }
        sudo chmod a+rx /usr/local/bin/youtube-dl
        echo "installing ffmpeg..."
        sudo apt update > build.log 2>&1 || { cat build.log && exit 1; }
        sudo apt install -y ffmpeg > build.log 2>&1 || { cat build.log && echo "::error title=Failed to install test dependency::failed to install ffmpeg" && exit 1; }
        echo "Test dependencies install SUCCESS!"

    - name: "Build CLI Binaries"
#      if: steps.cli-cache.outputs.cache-hit != 'true'
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo
        echo "======================================================"
        echo "BUILDING 0WALLET AND 0BOX CLI BINARIES:"
        echo "======================================================"
        echo
        echo "Building zwalletcli [${{ env.ZWALLET_BRANCH }}]..."
        cd zwalletcli
        if [[ -n "${{ inputs.custom_go_sdk_version }}" && "${{ inputs.custom_go_sdk_version }}" != "NONE" ]];
        then
          echo "Upgrading zwalletcli to GOSDK [${{ inputs.custom_go_sdk_version }}]"
          go get github.com/0chain/gosdk@${{ inputs.custom_go_sdk_version }} || { echo "::error title=Failed to retrieve gosdk::failed to retrieve gosdk [${{ inputs.custom_go_sdk_version }}]" && exit 1; }
          go mod tidy || { echo "::error title=Failed to upgrade gosdk on zwallet CLI::failed to upgrade zwallet CLI gosdk to [${{ inputs.custom_go_sdk_version }}]" && exit 1; }
        fi
        make install > build.log 2>&1 || { cat build.log && echo "::error title=zwallet CLI build failed::zwallet CLI build failed" && exit 1; }
        mv zwallet ../tests/cli_tests
        echo "Building zboxcli [${{ env.ZBOX_BRANCH }}]..."
        cd ../zboxcli
        if [[ -n "${{ inputs.custom_go_sdk_version }}" && "${{ inputs.custom_go_sdk_version }}" != "NONE" ]];
        then
          echo "Upgrading zboxcli to GOSDK [${{ inputs.custom_go_sdk_version }}]"
          go get github.com/0chain/gosdk@${{ inputs.custom_go_sdk_version }} || { echo "::error title=Failed to retrieve gosdk::failed to retrieve gosdk [${{ inputs.custom_go_sdk_version }}]" && exit 1; }
          go mod tidy || { echo "::error title=Failed to upgrade gosdk on zbox CLI::failed to upgrade zbox CLI gosdk to [${{ inputs.custom_go_sdk_version }}]" && exit 1; }
        fi
        make install > build.log 2>&1 || { cat build.log && echo "::error title=zbox CLI build failed::zbox CLI build failed" && exit 1; }
        mv zbox ../tests/cli_tests
        echo "CLI build SUCCESS!"

    - name: "Set up system tests"
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo
        echo "======================================================"
        echo "SETTING UP SYSTEM TESTS:"
        echo "======================================================"
        echo
        if [ "${{ inputs.retry_failures }}" == "true" ];
           then
              echo SHOULD_RETRY_FAILURES=--rerun-fails >> $GITHUB_ENV
          else
              echo SHOULD_RETRY_FAILURES='' >> $GITHUB_ENV
        fi

        BRANCH_DIR=$(echo $([ -z '${{ github.event.pull_request.head.sha }}' ] && echo ${GITHUB_REF#refs/*/} || echo $GITHUB_HEAD_REF) |  sed 's/\//_/g')
        echo "BRANCH_DIR=$BRANCH_DIR" >> $GITHUB_ENV
        echo "TEST_TIME=$(date '+%Y-%m-%d_%H.%M.%S')" >> $GITHUB_ENV
        go get gotest.tools/gotestsum
        go get github.com/vakenbolt/go-test-report
        cd tests/cli_tests
        mkdir -p ${BRANCH_DIR}/${GITHUB_SHA}/flaky
        sed "s,block_worker:.*,block_worker: https://${{ env.NETWORK_URL }}/dns," -i ./config/zbox_config.yaml
        printf '#!/bin/bash\nset -o pipefail\n[ -z "$1" ] && TESTS_TO_RUN="-run  ^Test[^___]*$ ./..." || TESTS_TO_RUN=$1\nCONFIG_PATH=./zbox_config.yaml go test -timeout=60m $TESTS_TO_RUN -json -count=1 | sed -r "/(=== (CONT|RUN|PAUSE).*)|(--- FAIL:.*)|(\\"Test\\":\\".*\/[pP]arallel\\")/d"' > TEST_RUNNER_COMMAND.sh && chmod 777 TEST_RUNNER_COMMAND.sh
        printf '#!/bin/bash\nset -o pipefail\nCONFIG_PATH=./zbox_config.yaml go test -timeout=60m -run  "^Test___Flaky.*$" ./... -json -count=1 | sed -r "/(=== (CONT|RUN|PAUSE).*)|(--- FAIL:.*)|(\\"Test\\":\\".*\/[pP]arallel\\")/d"' > FLAKY_TEST_RUNNER_COMMAND.sh && chmod 777 FLAKY_TEST_RUNNER_COMMAND.sh
        (./zwallet version --configDir ./config --config ./zbox_config.yaml --wallet ../ignore --silent | grep -A2 'Version info' | sed "s/Version info:/ZWallet Version Info:/") || true
        (./zbox version --configDir ./config --config ./zbox_config.yaml --wallet ../ignore --silent | grep -A2 'Version info' | sed "s/Version info:/ZBox Version Info:/") || true

    - name: "Run CLI System Tests"
      shell: 'script --return --quiet --command "bash {0}"'
      env:
        SMART_CONTRACT_OWNER_WALLET_JSON: ${{ inputs.smart_contract_owner_wallet_json }}
      run: |
        echo
        echo "======================================================"
        echo "RUNNING SYSTEM TESTS:"
        echo "======================================================"
        echo
        cd tests/cli_tests
        exit_code=0
        echo "$SMART_CONTRACT_OWNER_WALLET_JSON" >> ./config/sc_owner_wallet.json
        echo '{"client_id": "591d6d0d5642bdbc924756ca2647b4b59adce0acd02a487ecc4d1bd4669293a8","client_key": "ac8798bcadd5ce5ea14f4745850eec61aa080e6fedc1d769af95c42e0079ba03ee9710e9dc966f7c5eb9cd6ef9184af51869d5a345b9520e507aa55ba22bf902","keys": [{"public_key": "ac8798bcadd5ce5ea14f4745850eec61aa080e6fedc1d769af95c42e0079ba03ee9710e9dc966f7c5eb9cd6ef9184af51869d5a345b9520e507aa55ba22bf902","private_key": "fbdc0bcc12168588e2def826b7ee9d8b4c6f1fbacf22ee5064b7db49482b8f0d"}],"mnemonics": "economy day fan flower between rebuild valid bid catch bargain vivid hybrid room permit check manage mean twelve damage summer close churn boat either","version": "1.0","date_created": "2021-12-04T17:03:37Z"}' >> ./config/blobber_owner_wallet.json
       
        if [[ "${{ env.NETWORK_URL }}" == "dev-3.devnet-0chain.net" ]];
         then
            echo '{"client_id": "474f8a8b344d0bf8089072dac347092b8ca70b5270042a439c4a279154b2b7f4","client_key": "4469d4489274032f2a1161398b442445856f6c5f270fd75ae2f566dc1d345b16a2d05d43e4be91347453fdc8769b069beeb543f6ae64c5fb3555cfc907a13f91","keys": [{"public_key": "4469d4489274032f2a1161398b442445856f6c5f270fd75ae2f566dc1d345b16a2d05d43e4be91347453fdc8769b069beeb543f6ae64c5fb3555cfc907a13f91","private_key": "9c8336e9c4c94d29c8cf987e5b977866ba50a7a8b0b4c6ca36b48017da0b2a1e"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/miner_node_delegate_wallet.json
          elif [[ "${{ env.NETWORK_URL }}" == "dev-4.devnet-0chain.net" ]];
          then
            echo '{"client_id": "e62cb3d9101fbc940b037d4af3fe4ad6cb56ac51eb3736c0ffc55d4e77efac26","client_key": "a0342115c4fe7d4168479f94027db3d2449b40c96d5f060d9ebd108c2b0b2913019d38fd00ecf83cbc52fd4df0ab9c206cbfd1e1a53bbb7939e781b0b8f7c002","keys": [{"public_key": "a0342115c4fe7d4168479f94027db3d2449b40c96d5f060d9ebd108c2b0b2913019d38fd00ecf83cbc52fd4df0ab9c206cbfd1e1a53bbb7939e781b0b8f7c002","private_key": "b81bae416d34de8641b7b7d2c158f91138d4cbc7a863cdc2a12490f76df82501"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/miner_node_delegate_wallet.json
          elif [[ "${{ env.NETWORK_URL }}" == "dev-5.devnet-0chain.net" ]];
          then
            echo '{"client_id": "4e155064ef85f6349f43d7c78717a1278f1f1efff00075642ad112e26fe37063","client_key": "15ba3331cefd8c669d673750f4d97963ea8894d2cad5b4ea3a3802baaab4540c1e58db51b6dbf1fdd076bb4c7646fd9af97446a201e378b4fa8e158b100e6510","keys": [{"public_key": "15ba3331cefd8c669d673750f4d97963ea8894d2cad5b4ea3a3802baaab4540c1e58db51b6dbf1fdd076bb4c7646fd9af97446a201e378b4fa8e158b100e6510","private_key": "351234aef53b7d701dba08388b6f774a163cd46b24535be71e0bc98fc1f20009"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/miner_node_delegate_wallet.json
          elif [[ "${{ env.NETWORK_URL }}" == "dev-1.devnet-0chain.net" ]];
          then
            echo '{"client_id": "4cf1360e577fadb34c1c6552faf0e9ee7d0fd7c9547769e9b4ac22500f04afa6","client_key": "16f0829b4f62fbd614de5e488b489e467dde498c2f4931dc8b1e01414699d61d63ebba31166dcdbdb2b568427cbea31dff23f34a360ff9682c187a9b6ed7ab91","keys": [{"public_key": "16f0829b4f62fbd614de5e488b489e467dde498c2f4931dc8b1e01414699d61d63ebba31166dcdbdb2b568427cbea31dff23f34a360ff9682c187a9b6ed7ab91","private_key": "3c3708958924ad55529faab98c882b317c2da228cbe3fcd23d2b379074b64017"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/miner_node_delegate_wallet.json          
          elif [[ "${{ env.NETWORK_URL }}" == "dev-2.devnet-0chain.net" ]];
          then
            echo '{"client_id": "b37393136ad49902ae47da6c2204001ae8979757c0851949f1d44290ed42a4ab","client_key": "472973e256834c8630f3d02a0cac3ddf0ee2e3b8243ffe83238ee0c069d8d60c0922c10767d452a9fe86726bf7d27bc071f15c4ad139205b1769ca1b4a67c616","keys": [{"public_key": "472973e256834c8630f3d02a0cac3ddf0ee2e3b8243ffe83238ee0c069d8d60c0922c10767d452a9fe86726bf7d27bc071f15c4ad139205b1769ca1b4a67c616","private_key": "e103bb103212e3f7c17f1bba9c8bfa074997468a930ebf66d1c9b3dd508ba619"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/miner_node_delegate_wallet.json
        fi
        if [[ "${{ env.NETWORK_URL }}" == "dev-3.devnet-0chain.net" ]];
          then
            echo '{"client_id": "cc08007c5cb676bc1395ba155fe3fa7d1754e70f76296e31825413916d62451a","client_key": "2244839a6605e4ffa1b361ae404a5d173edc21ee2e644adbc0d50e6929676a118bbc729c33c9bf071926e12472b0d3fbdcd9a17fde4f7d94a3dad7f768e1779d","keys": [{"public_key": "2244839a6605e4ffa1b361ae404a5d173edc21ee2e644adbc0d50e6929676a118bbc729c33c9bf071926e12472b0d3fbdcd9a17fde4f7d94a3dad7f768e1779d","private_key": "4336849617efee2f8b7a8e78b472c6bd8dad93898a29c7e134bffac523ed5610"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/sharder_node_delegate_wallet.json
          elif [[ "${{ env.NETWORK_URL }}" == "dev-4.devnet-0chain.net" ]];
          then
            echo '{"client_id": "539d1f77daacda9c0baedec5e07500f71611a9c824c532ea8b9d1d6fb87a471e","client_key": "d3677ebedffffe9c5343dd4db35211500a0dc13db60246872c0a8e8ff33bf9080a72744191267d0f423abdb875911f226d95724a37a1966dac09214f05a79586","keys": [{"public_key": "d3677ebedffffe9c5343dd4db35211500a0dc13db60246872c0a8e8ff33bf9080a72744191267d0f423abdb875911f226d95724a37a1966dac09214f05a79586","private_key": "b6794b3bf8a5376c8cf81a51e5731ad0e9d4f978032a9335072f66efe5b0eb1f"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/sharder_node_delegate_wallet.json
          elif [[ "${{ env.NETWORK_URL }}" == "dev-5.devnet-0chain.net" ]];
          then
            echo '{"client_id": "3ba0f82565a4605ab416549c083147958e4fe527f11ab8baff2c70add7fbccf6","client_key": "d9326b50fc0673621f42e3c7192aaa6982582b0ebd04302bc4ead354b618b91afb58fe2b2c50f533b45a9da565176477cd1899426bbbf77487a6d50c8cadcf8d","keys": [{"public_key": "d9326b50fc0673621f42e3c7192aaa6982582b0ebd04302bc4ead354b618b91afb58fe2b2c50f533b45a9da565176477cd1899426bbbf77487a6d50c8cadcf8d","private_key": "7e60e83f6b8defe2b5c062acc4951126ea494cec2c5d09c0161e8bbd9f846c1f"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/sharder_node_delegate_wallet.json
          elif [[ "${{ env.NETWORK_URL }}" == "dev-1.devnet-0chain.net" ]];
          then
            echo '{"client_id": "78483a1f8cb8a62526eb4284be939168c7fa1014852a8c872936734ed8c150cb","client_key": "1ed014bc317b5117204d90acf18a1997d8f112a36699330ef0c6d0b10c6d2c06be05fb604b3801b52f030e462a02098dbf2bebcb46e10e2e7ad9c7bc4d8e6916","keys": [{"public_key": "1ed014bc317b5117204d90acf18a1997d8f112a36699330ef0c6d0b10c6d2c06be05fb604b3801b52f030e462a02098dbf2bebcb46e10e2e7ad9c7bc4d8e6916","private_key": "b49b7ffa0a97dde85ec916b4daaed5dd466088880f58c99546ae1d955cb35519"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/sharder_node_delegate_wallet.json          
          elif [[ "${{ env.NETWORK_URL }}" == "dev-2.devnet-0chain.net" ]];
          then
            echo '{"client_id": "6d30027fb65a5aad2b072ab39cde5893b3cd32694dff7bbba5f9e6eef8def505","client_key": "57d240fa82f64ba8092f620a0346230b1a590720de4d7bbc8ce1e0a4824b0b031c3f3e11801b0cead5511051847ea875a3ec7267b4c9d9a9f12740d6803d5382","keys": [{"public_key": "57d240fa82f64ba8092f620a0346230b1a590720de4d7bbc8ce1e0a4824b0b031c3f3e11801b0cead5511051847ea875a3ec7267b4c9d9a9f12740d6803d5382","private_key": "f40373682a538933ba3898a03f02d2596af275ac8fd0e05aada1247f3cc0751b"}],"mnemonics": "ugly train lock tomorrow garden sweet market marble mouse icon visit gather damp hair mother under into robot machine ahead science distance rescue enjoy","version": "1.0","date_created": "2021-12-08 17:58:02.329290633 +0100 CET m=+0.002796956"}' >> ./config/sharder_node_delegate_wallet.json
        fi
        
        ~/go/bin/gotestsum --jsonfile test-output.json --hide-summary=output --format testname ${{ env.SHOULD_RETRY_FAILURES }} --raw-command -- ./TEST_RUNNER_COMMAND.sh || exit_code=$?
        cat test-output.json | ~/go/bin/go-test-report --groupSize 1 --output ${{ env.BRANCH_DIR }}/${GITHUB_SHA}/index.html --title "0Chain System test suite [${{ env.BRANCH_DIR }}/${GITHUB_SHA:0:8}] ran against [${{ env.NETWORK_URL }}] at [${{ env.TEST_TIME }}]"
        rm -rf ./config/sc_owner_wallet.json || true
        rm -rf ./config/blobber_owner_wallet.json || true
        rm -rf ./config/miner_node_delegate_wallet.json || true
        rm -rf ./config/sharder_node_delegate_wallet.json || true
        cp -R ./${{ env.BRANCH_DIR }}/${GITHUB_SHA} ./${{ env.BRANCH_DIR }}/latest
        echo "TESTS_RAN=true" >> $GITHUB_ENV

        if [[ $exit_code == 0 ]];
          then
            echo TESTS_PASSED=true >> $GITHUB_ENV
          else
            echo TESTS_PASSED=false >> $GITHUB_ENV
            echo "::error title=System tests faled!::System tests failed. Ensure tests are running against the correct images/branches before attempting a re-run"
        fi

        exit $exit_code

    - name: "Archive CLI Config & Console Output"
      if: ${{ always() && env.TESTS_RAN == 'true' && inputs.archive_results == 'true' }}
      uses: actions/upload-artifact@v2
      with:
        name: System-Test-${{ env.TEST_TIME }}
        path: |
          ./tests/cli_tests/config
          ./tests/cli_tests/cmdlog.log
          ./tests/cli_tests/${{ env.BRANCH_DIR }}/latest/index.html

    - name: "Run Flaky CLI System Tests"
      if:  ${{ always() && env.TESTS_RAN == 'true' && inputs.run_flaky_tests == 'true' }}
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo
        echo "======================================================"
        echo "RUNNING FLAKY SYSTEM TESTS:"
        echo "======================================================"
        echo
        cd tests/cli_tests
        rm -rf cmdlog.log || true
        rm -rf test-output.json || true
        ~/go/bin/gotestsum --jsonfile test-output.json --hide-summary=output --format testname --raw-command -- ./FLAKY_TEST_RUNNER_COMMAND.sh || true
        cat test-output.json | ~/go/bin/go-test-report --groupSize 1 --output ${{ env.BRANCH_DIR }}/${GITHUB_SHA}/flaky/index.html --title "0Chain Flaky system test suite [${{ env.BRANCH_DIR }}/${GITHUB_SHA:0:8}] ran against [${{ env.NETWORK_URL }}] at [${{ env.TEST_TIME }}]"
        cp -R ./${{ env.BRANCH_DIR }}/${GITHUB_SHA}/flaky ./${{ env.BRANCH_DIR }}/latest/flaky
        echo "FLAKY_TESTS_RAN=true" >> $GITHUB_ENV

    - name: "Archive Flaky Test CLI Config & Console Output"
      if: ${{ always() && env.FLAKY_TESTS_RAN == 'true' && inputs.archive_results  == 'true'}}
      uses: actions/upload-artifact@v2
      with:
        name: Flaky-System-Test-${{ env.TEST_TIME }}
        path: |
          ./tests/cli_tests/config
          ./tests/cli_tests/cmdlog.log
          ./tests/cli_tests/${{ env.BRANCH_DIR }}/latest/flaky/index.html

    - name: "Deploy report pages"
      if: ${{ always() && env.TESTS_RAN == 'true' && inputs.deploy_report_page == 'true' }}
      uses: peaceiris/actions-gh-pages@v3
      with:
        publish_branch: test_reports
        keep_files: true
        github_token: "${{ inputs.svc_account_secret }}"
        publish_dir: "./tests/cli_tests/${{ env.BRANCH_DIR }}"
        destination_dir: "./${{ env.BRANCH_DIR }}"
        user_name: "github-actions[bot]"
        user_email: "github-actions[bot]@users.noreply.github.com"

    - name: "Wait for report deployment to complete"
      if: ${{ always() && env.TESTS_RAN == 'true' && inputs.deploy_report_page == 'true' }}
      shell: 'script --return --quiet --command "bash {0}"'
      run: counter=0; while [ $counter -lt 5 ] && curl -o /dev/null -Isw '%{http_code}\n' "https://0chain.github.io/${{ github.event.repository.name }}/${{ env.BRANCH_DIR }}/${GITHUB_SHA}/index.html?t=$(date +%s)" | grep -v 200 > /dev/null; do sleep 10 && echo "Waiting for report page to deploy..." && ((counter=counter+1)); done

    - name: "Report Links"
      if: ${{ always() && env.TESTS_RAN == 'true' && inputs.deploy_report_page == 'true' }}
      shell: 'script --return --quiet --command "bash {0}"'
      run: |
        echo
        echo "======================================================"
        echo "SYSTEM TESTS HTML REPORTS:"
        echo "======================================================"
        echo
        echo "::notice title=System tests report::System tests report: https://0chain.github.io/${{ github.event.repository.name }}/${{ env.BRANCH_DIR }}/${GITHUB_SHA}/index.html"
        if [ "${{ env.FLAKY_TESTS_RAN }}" == "true" ];
           then
              echo "::notice title=Flaky system tests report::Flaky system tests report: https://0chain.github.io/${{ github.event.repository.name }}/${{ env.BRANCH_DIR }}/${GITHUB_SHA}/flaky/index.html"
        fi